name: Get and Validate JWT

on:
  workflow_dispatch:

jobs:
  get_and_validate_jwt:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Get JWT
        id: get_token
        uses: actions/github-script@v6
        with:
          script: |
            const token = await core.getIDToken()
            console.log(token)
            core.setOutput('token', token)

      - name: Validate JWT
        env:
          OIDC_SERVICE_URL: "oidcservice-production.up.railway.app"
        run: |
          TOKEN="${{ steps.get_token.outputs.token }}"
          RESPONSE=$(curl -s -X POST $OIDC_SERVICE_URL \
            -H "Content-Type: application/json" \
            -d "{\"token\": \"$TOKEN\"}")
          echo "OIDC Service Response: $RESPONSE"
          if [[ $RESPONSE == *"Invalid token"* ]]; then
            echo "Token validation failed"
            exit 1
          else
            echo "Token validated successfully"
          fi
